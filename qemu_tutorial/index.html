<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>使用QEMU创建Linux虚拟机 - wlupus blog</title><meta name=author content="wlupus: https://wlupus.github.io"><meta name=description content="在macos下搭建linux环境的一点记录"><meta name=keywords content="qemu,linux"><meta itemprop=name content="使用QEMU创建Linux虚拟机"><meta itemprop=description content="在macos下搭建linux环境的一点记录"><meta itemprop=datePublished content="2023-03-02T11:58:45+08:00"><meta itemprop=dateModified content="2023-03-07T15:01:33+08:00"><meta itemprop=wordCount content="883"><meta itemprop=image content="https://wlupus.github.io/qemu_tutorial/@heripiro-FiE2lirUYAAStgo.jpg"><meta itemprop=keywords content="qemu,linux,"><meta property="og:title" content="使用QEMU创建Linux虚拟机"><meta property="og:description" content="在macos下搭建linux环境的一点记录"><meta property="og:type" content="article"><meta property="og:url" content="https://wlupus.github.io/qemu_tutorial/"><meta property="og:image" content="https://wlupus.github.io/qemu_tutorial/@heripiro-FiE2lirUYAAStgo.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-02T11:58:45+08:00"><meta property="article:modified_time" content="2023-03-07T15:01:33+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wlupus.github.io/qemu_tutorial/@heripiro-FiE2lirUYAAStgo.jpg"><meta name=twitter:title content="使用QEMU创建Linux虚拟机"><meta name=twitter:description content="在macos下搭建linux环境的一点记录"><meta name=application-name content="wlupus"><meta name=apple-mobile-web-app-title content="wlupus"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#252627"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://wlupus.github.io/qemu_tutorial/><link rel=prev href=https://wlupus.github.io/react_tutorial/><link rel=next href=https://wlupus.github.io/writeup_ciscn_2019_c_1/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"使用QEMU创建Linux虚拟机","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/wlupus.github.io\/qemu_tutorial\/"},"image":[{"@type":"ImageObject","url":"https:\/\/wlupus.github.io\/qemu_tutorial\/@heripiro-FiE2lirUYAAStgo.jpg","width":1505,"height":2125}],"genre":"posts","keywords":"qemu, linux","wordcount":883,"url":"https:\/\/wlupus.github.io\/qemu_tutorial\/","datePublished":"2023-03-02T11:58:45+08:00","dateModified":"2023-03-07T15:01:33+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"wlupus","logo":{"@type":"ImageObject","url":"https:\/\/wlupus.github.io\/images\/avatar.png","width":634,"height":634}},"author":{"@type":"Person","name":"wlupus"},"description":"在macos下搭建linux环境的一点记录"}</script></head><body header-desktop=sticky header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="wlupus blog"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/logo.svg data-srcset="/images/logo.svg, /images/logo.svg 1.5x, /images/logo.svg 2x" data-sizes=auto alt=/images/logo.svg title=/images/logo.svg><span class=header-title-text>wlupus</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class='fas fa-archive fa-fw fa-sm'></i> 所有文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class='fas fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class='fas fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class='fas fa-users fa-fw fa-sm'></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class='fas fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fas fa-chevron-down"></i></span><ul class=sub-menu><li class=menu-item>没有更多翻译</li></ul></li><li class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></li></ul></nav><a href=https://github.com/wlupus/wlupus.github.io title="在 GitHub 上查看源代码" target=_blank rel="external nofollow noopener noreffer" class=github-corner><svg width="56" height="56" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="wlupus blog"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/logo.svg data-srcset="/images/logo.svg, /images/logo.svg 1.5x, /images/logo.svg 2x" data-sizes=auto alt=/images/logo.svg title=/images/logo.svg><span class=header-title-text>wlupus</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=menu-item><a class=menu-link href=/posts/><i class='fas fa-archive fa-fw fa-sm'></i> 所有文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class='fas fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class='fas fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class='fas fa-users fa-fw fa-sm'></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class='fas fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fas fa-chevron-down"></i></span>
<select class=language-select onchange="location=this.value"><option disabled>没有更多翻译</option></select></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><h1 class="single-title animate__animated animate__flipInX">使用QEMU创建Linux虚拟机</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://wlupus.github.io title=Author target=_blank rel="external nofollow noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>wlupus</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E7%AC%94%E8%AE%B0/><i class="far fa-folder fa-fw"></i>笔记</a></span></div><div class=post-meta-line><span title="2023-03-02 11:58:45"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-03-02>2023-03-02</time>
</span>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 883 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 2 分钟&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/qemu_tutorial/@heripiro-FiE2lirUYAAStgo.jpg data-srcset="/qemu_tutorial/@heripiro-FiE2lirUYAAStgo.jpg, /qemu_tutorial/@heripiro-FiE2lirUYAAStgo.jpg 1.5x, /qemu_tutorial/@heripiro-FiE2lirUYAAStgo.jpg 2x" data-sizes=auto alt=/qemu_tutorial/@heripiro-FiE2lirUYAAStgo.jpg title=在macos下搭建linux环境的一点记录></div><div class="details toc" id=toc-static kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-安装qemu>1 安装qemu</a></li><li><a href=#2-创建硬盘镜像>2 创建硬盘镜像</a></li><li><a href=#3-准备安装介质>3 准备安装介质</a></li><li><a href=#4-安装操作系统>4 安装操作系统</a></li><li><a href=#5-运行系统>5 运行系统</a></li><li><a href=#6-端口映射>6 端口映射</a></li></ul></nav></div></div><div class=content id=content><h2 id=1-安装qemu>1 安装qemu</h2><p>使用包管理器安装即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>brew install qemu
</span></span></code></pre></td></tr></table></div></div><p>qemu有两种工作模式：system emulation & user mode emulation, 本文中使用system emulation的模式</p><h2 id=2-创建硬盘镜像>2 创建硬盘镜像</h2><p>硬盘镜像是一个文件，用来存储虚拟机硬盘上的内容。qemu支持的镜像有两种格式，分别是<code>raw</code>和<code>qcow2</code>。raw格式I/O开销小，但是占用全量空间(分配大小即为实际大小)；qcow2格式仅当系统实际写入内容时，才会分配空间，另外还支持快照。这里采用qcow2格式</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>qemu-img create -f qcow2 server_file 60G
</span></span></code></pre></td></tr></table></div></div><h2 id=3-准备安装介质>3 准备安装介质</h2><p>下载ubuntu18.04 server版本的iso镜像，放到image file相同路径下。之所以选择server版本，是因为在m1 mac下运行x86的虚拟机效率很低，带图形化界面会很卡，基本难以使用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ls
</span></span><span class=line><span class=cl>server_file  ubuntu-18.04.6-live-server-amd64.iso
</span></span></code></pre></td></tr></table></div></div><h2 id=4-安装操作系统>4 安装操作系统</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>qemu-system-x86_64 -smp 4\
</span></span><span class=line><span class=cl>    -m 8G\
</span></span><span class=line><span class=cl>    -cdrom ubuntu-18.04.6-live-server-amd64.iso\
</span></span><span class=line><span class=cl>    -boot order=d\
</span></span><span class=line><span class=cl>    -drive file=server_file,format=qcow2
</span></span></code></pre></td></tr></table></div></div><p>以<code>qemu-system-*</code>格式命名的程序有很多，其中<code>*</code>处代表的是客户机(Guest)对应的架构。本文中是在arm平台下起x86的虚拟机，所以选择<code>qemu-system-x86_64</code></p><p>命令中涉及的部分参数含义：</p><ul><li><code>-smp</code> 指定cpu数量</li><li><code>-m</code> 指定内存数量</li><li><code>-boot</code> 其中有二级参数，order参数指定启动介质，可选值有a, b(floppy 1 and 2), c(first hard disk), d(first CD-ROM)</li><li><code>-drive</code> 定义一个新的drive(或者blockdev)，二级参数file指定该设备使用的硬盘镜像</li></ul><p>更多参数相关请参考<a href=https://www.qemu.org/docs/master/system/invocation.html target=_blank rel="external nofollow noopener noreffer">qemu文档
<i class="fas fa-external-link-alt fa-fw fa-xs"></i></a></p><h2 id=5-运行系统>5 运行系统</h2><p>安装完成后需要重启，此时将cdrom的挂载去掉，并将<code>-boot</code>参数去掉即可(默认从硬盘启动)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>qemu-system-x86_64 -smp 4\
</span></span><span class=line><span class=cl>    -m 8G\
</span></span><span class=line><span class=cl>    -drive file=server_file,format=qcow2
</span></span></code></pre></td></tr></table></div></div><p>如果不想看到qemu弹出的虚拟机窗口，可以添加<code>-display none</code>参数</p><h2 id=6-端口映射>6 端口映射</h2><p>为了方便ssh连接虚拟机，采用将guest的22端口映射到host的端口的方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>qemu-system-x86_64 -smp 4\
</span></span><span class=line><span class=cl>    -m 8G\
</span></span><span class=line><span class=cl>    -drive file=server_file,format=qcow2\
</span></span><span class=line><span class=cl>    -nic user,hostfwd=tcp::10022-:22\
</span></span><span class=line><span class=cl>    -display none
</span></span></code></pre></td></tr></table></div></div><p>添加参数<code>-nic</code>，user指config user mode host network backend, <code>hostfwd=[tcp|udp]:[hostaddr]:hostport-[guestaddr]:guestport</code></p><p>如果guest需要使用host的代理服务，可以配置如下环境变量</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>export http_proxy=http://ip_addr:port
</span></span><span class=line><span class=cl>export https_proxy=http://ip_addr:port
</span></span><span class=line><span class=cl># ip_addr 为host的ip地址，port为host代理服务的端口号
</span></span></code></pre></td></tr></table></div></div><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw"></i>技巧<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>qemu中默认映射的host ip地址为10.0.2.2</div></div></div><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fw"></i>警告<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>经过测试后发现，性能还是很差，gdb之类的工具用起来会有明显延迟，只能图一乐</div></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2023-03-07 15:01:33">更新于 2023-03-07&nbsp;<a class=git-hash href=https://github.com/wlupus/wlupus.github.io/commit/a90ec9057481cfff8cfe4c0251cb68c0476368cc rel="external nofollow noopener noreffer" target=_blank title="commit by Reload(wlupus@MacBookPro.local) a90ec9057481cfff8cfe4c0251cb68c0476368cc: add ciscn_2019_c writeup">
<i class="fas fa-hashtag fa-fw"></i>a90ec90</a></span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/qemu_tutorial/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://wlupus.github.io/qemu_tutorial/ data-title=使用QEMU创建Linux虚拟机 data-via=wlupus1 data-hashtags=qemu,linux><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://wlupus.github.io/qemu_tutorial/ data-hashtag=qemu><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://wlupus.github.io/qemu_tutorial/ data-title=使用QEMU创建Linux虚拟机><i data-svg-src=/lib/simple-icons/icons/line.min.svg></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/qemu/>qemu</a>,&nbsp;<a href=/tags/linux/>linux</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/react_tutorial/ class=prev rel=prev title="React 入门笔记"><i class="fas fa-angle-left fa-fw"></i>React 入门笔记</a>
<a href=/writeup_ciscn_2019_c_1/ class=next rel=next title="Ciscn_2019_c_1 Writeup">Ciscn_2019_c_1 Writeup<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line copyright"><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=https://wlupus.github.io target=_blank rel="external nofollow noopener noreffer">wlupus</a></span><span class=footer-divider></span><span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js async defer></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js defer></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js defer></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js defer></script><script type=text/javascript src=/lib/sharer/sharer.min.js async defer></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript src=/lib/pangu/pangu.min.js defer></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,enablePangu:!0,lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1}}</script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/_custom.min.js defer></script></body></html>